# v0.9.0 — REST Controller de Licencias (CRUD)

**VERSIÓN:** v0.9.0  
**SLUG:** controller-licencias  
**DEPENDENCIAS:** v0.4.0 (JWT)  
**ESTIMACIÓN:** 45min  
**PRIORIDAD:** alta

---

## Descripción

Implementar **LicenciaRestController** con endpoints para **crear**, **editar**, **eliminar** y **listar** licencias, siguiendo el patrón de `CompraRestController` y `SeguroRestController`. Autenticación con JWT en header `Authorization: Bearer <token>`; datos en body JSON. La capa de negocio (`ILicenciaBusiness`) y la entidad `Licencia` ya existen.

---

## PASO 0 — Contexto previo a leer

- `gestion/src/main/java/com/gestion/qnt/model/Licencia.java` — nombre, numLicencia, compra (opcional), fechaCompra, caducidad, version, activo.
- `gestion/src/main/java/com/gestion/qnt/model/business/interfaces/ILicenciaBusiness.java` — list(), load(id), add(), update(), delete().
- `gestion/src/main/java/com/gestion/qnt/controller/SeguroRestController.java` o `CompraRestController.java` — patrón de controlador.
- `gestion/src/main/java/com/gestion/qnt/config/ApiConstants.java` — URL_BASE.

---

## PASO 1 — DTO de request para Licencia

Crear en `gestion/src/main/java/com/gestion/qnt/controller/dto/`:

**CreateLicenciaRequest** (record o clase) con campos:

- `nombre` (String, obligatorio)
- `numLicencia` (String, opcional)
- `compraId` (Long, opcional) — para asociar la licencia a una compra existente
- `fechaCompra` (LocalDate, opcional)
- `caducidad` (LocalDate, opcional)
- `version` (String, opcional)
- `activo` (Boolean, opcional; default true)

Usar `@JsonProperty` si hace falta. Validaciones: `@NotNull` en nombre si se usa Bean Validation.

---

## PASO 2 — LicenciaRestController

- **Clase:** `LicenciaRestController` en paquete `com.gestion.qnt.controller`.
- **Base URL:** `ApiConstants.URL_BASE + "/licencias"` → `/api/qnt/v1/licencias`.
- **Inyectar:** `ILicenciaBusiness` y `ICompraBusiness` (para resolver `compraId` opcional al crear/actualizar).

Endpoints:

| Método | Ruta    | Descripción                     | Autorización        |
|--------|---------|---------------------------------|---------------------|
| GET    | /       | Listar todas las licencias      | Autenticado         |
| GET    | /{id}   | Obtener licencia por id         | Autenticado         |
| POST   | /       | Crear licencia (body: DTO)      | Autenticado         |
| PUT    | /{id}   | Actualizar licencia (body: DTO) | Autenticado         |
| DELETE | /{id}   | Eliminar licencia por id        | Autenticado (ADMIN) |

- **Crear:** si viene `compraId`, cargar `Compra` con `compraBusiness.load(compraId)`; si no existe → 404. Armar entidad `Licencia`, setear compra si corresponde, activo por defecto true si no viene. `licenciaBusiness.add(licencia)`, devolver 201 CREATED.
- **Actualizar:** cargar licencia por id; si no existe → 404. Aplicar campos del DTO; si viene `compraId`, cargar compra y setear (o null si no viene). `licenciaBusiness.update(licencia)`, devolver 200 OK.
- **Eliminar:** `licenciaBusiness.delete(id)` → 204 No Content. 404 si no existe.
- **Listar / GET por id:** delegar en `licenciaBusiness.list()` y `licenciaBusiness.load(id)`. Si hay `LazyInitializationException` (relación Compra), usar `@Transactional(readOnly = true)` en el método del controller o en el servicio.

**Verificación:** compilación OK; rutas bajo `/api/qnt/v1/licencias` protegidas con JWT.

---

## PASO 3 — Seguridad y documentación

- Rutas `/api/qnt/v1/licencias/**` requieren autenticación (JWT). No usar `permitAll`.
- Actualizar `docs/COMO_PROBAR_API.md`: sección **Licencias** con ejemplos de GET/POST/PUT/DELETE (header `Authorization: Bearer <token>`, body JSON de ejemplo).

---

## PASO 4 — Commit y tag

```bash
VERSION="v0.9.0"
SLUG="controller-licencias"

git add gestion/src/main/java/com/gestion/qnt/controller/LicenciaRestController.java \
        gestion/src/main/java/com/gestion/qnt/controller/dto/CreateLicenciaRequest.java \
        docs/COMO_PROBAR_API.md

git commit --no-verify -m "feat(licencias): REST controller CRUD licencias

- LicenciaRestController GET list, GET by id, POST, PUT, DELETE
- DTO CreateLicenciaRequest (nombre, numLicencia, compraId, fechas, activo)
- Rutas protegidas JWT; documentación en COMO_PROBAR_API"

git tag -a "${VERSION}" -m "Release v0.9.0: Controller Licencias"
```

---

## Verificación final

- [ ] Build sin errores.
- [ ] POST /api/qnt/v1/licencias con JWT y body JSON crea una licencia (201).
- [ ] PUT /api/qnt/v1/licencias/{id} actualiza y devuelve 200.
- [ ] DELETE /api/qnt/v1/licencias/{id} devuelve 204.
- [ ] GET sin token → 401.
- [ ] Documentación actualizada con ejemplos.

---

## Notas

- La entidad `Licencia` tiene relación opcional con `Compra`; el DTO usa `compraId` para no exponer entidades anidadas en el JSON de entrada.
