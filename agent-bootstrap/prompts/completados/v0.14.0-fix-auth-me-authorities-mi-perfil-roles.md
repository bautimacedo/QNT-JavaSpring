# v0.14.0 — Fix: permisos piloto en front (GET /auth/me y GET /mi-perfil)

**VERSIÓN:** v0.14.0  
**SLUG:** fix-auth-me-authorities-mi-perfil-roles  
**DEPENDENCIAS:** v0.4.0 (JWT), v0.12.0 (mi-perfil)  
**ESTIMACIÓN:** 30 min  
**PRIORIDAD:** alta

---

## Problema

La pantalla **Perfil Piloto** (/perfil-piloto) en el frontend muestra "No tenés permisos" a un usuario con **ROLE_PILOTO** porque el front no puede determinar que el usuario es piloto. El front usa dos fuentes:

1. **GET /auth/me** — espera `authorities`: **array de strings** (ej. `["ROLE_PILOTO"]`).
2. **GET /mi-perfil** — espera `roles` en la respuesta (array de objetos `{ id, codigo, nombre }`), ya sea en la raíz o dentro de `usuario`.

Si alguna de las dos falla (formato distinto, campo ausente o null), el front no reconoce al piloto y bloquea la vista.

---

## Solución aplicada en backend

### 1. GET /auth/me — formato de `authorities`

- **Antes:** Se devolvía el `Principal` (AuthUser) directamente; al serializar con Jackson, `getAuthorities()` puede convertirse en un array de objetos `{"authority": "ROLE_PILOTO"}`, no en un array de strings.
- **Ahora:** El endpoint devuelve un DTO **AuthMeResponse** con formato fijo:
  - `id`, `email`, `username`, **`authorities`**: `List<String>` (ej. `["ROLE_PILOTO"]`).
- **Archivos:** `AuthMeResponse.java` (record en controller.dto), `AuthRestController.me()` construye y devuelve ese DTO.

**Verificación:** Con token de un usuario PILOTO, `GET /api/qnt/v1/auth/me` debe devolver `"authorities": ["ROLE_PILOTO"]` (array de strings).

### 2. GET /mi-perfil — campo `roles` visible

- **Antes:** La respuesta ya incluía `usuario` (con `roles` cargados por findByIdWithRoles), pero el front podía estar leyendo `response.roles` en la raíz.
- **Ahora:** Se añade en la raíz del JSON **`roles`**: el mismo array de roles del usuario (`usuario.getRoles()`), de modo que el front puede usar tanto `response.roles` como `response.usuario.roles`.
- **Archivo:** `MiPerfilPilotoController.getMiPerfil()` — `body.put("roles", usuario.getRoles() != null ? usuario.getRoles() : List.of())`.

**Verificación:** Con token PILOTO, `GET /api/qnt/v1/mi-perfil` debe incluir en la raíz `"roles": [{ "id": 2, "codigo": "ROLE_PILOTO", "nombre": "Piloto" }]` y también `usuario.roles` con el mismo contenido.

### 3. Documentación

- **INFORME_BACKEND_PARA_FRONTEND.md:** Actualizado §3.5 (GET /auth/me) para dejar claro que `authorities` es siempre un array de strings y que el front debe usarlo para rutas como Perfil Piloto. Añadida nota en §5.7 (GET /mi-perfil) sobre la respuesta con `usuario`, `roles` en raíz, `tieneImagenCma` y `licencias`.

---

## Verificación final

- [ ] GET /auth/me con token PILOTO devuelve `authorities`: ["ROLE_PILOTO"] (strings).
- [ ] GET /mi-perfil con token PILOTO devuelve `roles` en la raíz y `usuario.roles` con al menos ROLE_PILOTO.
- [ ] El frontend, al cargar DashboardLayout (auth/me) o la vista Perfil Piloto (mi-perfil), puede detectar el rol y mostrar la sección sin "No tenés permisos".
- [ ] Build sin errores.

---

## Notas para el frontend

Si el backend ya está actualizado y aun así el front muestra "No tenés permisos", revisar:

- Que la vista use **`response.authorities`** de GET /auth/me y compruebe `response.authorities.includes("ROLE_PILOTO")` (o equivalente).
- O que use **`response.roles`** o **`response.usuario.roles`** de GET /mi-perfil y compruebe que algún elemento tenga `codigo === "ROLE_PILOTO"`.
