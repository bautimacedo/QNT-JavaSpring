# v0.12.0 — Acciones de piloto: CMA, licencia ANAC e imagen (mi-perfil)

**VERSIÓN:** v0.12.0  
**SLUG:** piloto-mi-perfil-cma-licencia  
**DEPENDENCIAS:** v0.4.0 (JWT), v0.5.0 (usuarios/roles)  
**ESTIMACIÓN:** 2h 30min  
**PRIORIDAD:** alta

---

## Objetivo

Un usuario con rol **PILOTO** debe poder **gestionar su perfil de piloto** sin depender de un admin: actualizar su **CMA** (Certificado Médico Aeronáutico) — fecha de vencimiento y subir la imagen del certificado —, y gestionar sus **licencias ANAC** (alta, edición, baja, subir imagen de la licencia). Además, **cualquier usuario autenticado** (PILOTO, ADMIN o USER) debe poder gestionar **la configuración propia de su perfil** en la misma base `/mi-perfil`: **cambio de contraseña** y **actualización de sus datos** (nombre, apellido, DNI, etc.). Todo bajo la base URL **`/api/qnt/v1/mi-perfil`**. El recurso es siempre el usuario actual (no se permite editar a otro).

---

## Enfoque profesional propuesto

1. **Un solo controller "Mi perfil"** bajo `/mi-perfil`: agrupa **configuración del perfil** (datos editables + cambio de contraseña), CMA, licencias e imagen de licencia. Quien llama es el usuario autenticado; no se usa `usuarioId` en path/body para evitar que un usuario toque datos de otro.
2. **Configuración propia:** cualquier usuario autenticado puede actualizar sus datos (nombre, apellido, DNI, etc.) con **PUT /mi-perfil** y cambiar su contraseña con **PUT /mi-perfil/cambio-password** (body: `oldPassword`, `newPassword`). Estos endpoints pueden estar protegidos con `@PreAuthorize("isAuthenticated()")` o con los roles PILOTO, ADMIN y USER; los de CMA y licencias solo para PILOTO o ADMIN.
3. **CMA en Usuario:** ya existen `cmaVencimiento` y `cmaImagenes` (String). Se agrega **imagen del CMA** como `byte[]` en `Usuario` (ej. campo `imagenCma` @Lob) para subir/descargar el documento, igual que la imagen de factura en Compra.
4. **Licencia ANAC:** la entidad `Licencia` hoy tiene `Compra` (opcional). Se agrega **relación opcional con el piloto**: `Usuario piloto` (ManyToOne) en `Licencia`. Así un piloto puede tener varias licencias (ANAC u otras); cada una con número, caducidad y opcionalmente imagen. CRUD de “mis licencias” filtrado por `piloto = usuario actual`.
5. **Imagen por licencia:** campo `imagen` (byte[] @Lob) en `Licencia` para el documento/imagen de esa licencia; endpoints para subir y obtener.

---

## PASO 0 — Contexto previo a leer

- `gestion/src/main/java/com/gestion/qnt/model/Usuario.java` (cmaVencimiento, cmaImagenes, horasVuelo, cantidadVuelos)
- `gestion/src/main/java/com/gestion/qnt/model/Licencia.java`
- `gestion/src/main/java/com/gestion/qnt/controller/CompraRestController.java` (patrón de imagen en Compra: PUT/GET imagen)
- `gestion/src/main/java/com/gestion/qnt/security/AuthUser.java` (obtener id/email del usuario autenticado)
- `gestion/src/main/java/com/gestion/qnt/config/ApiConstants.java`
- Interfaces/capas: IUsuarioBusiness, ILicenciaBusiness (o LicenciaRepository si se accede directo)

---

## PASO 1 — Modelo: CMA con imagen y Licencia con piloto e imagen

**1.1 Usuario**

- Agregar en `Usuario` un campo para la imagen del CMA, por ejemplo:  
  `private byte[] imagenCma;`  
  Anotaciones: `@Lob`, `@Column(nullable = true)`, `@JsonIgnore` (para no serializar en JSON del usuario).  
  Misma idea que `imagenFactura` en Compra.

**1.2 Licencia**

- Agregar en `Licencia`:  
  - `@ManyToOne(fetch = FetchType.LAZY) @JoinColumn(name = "piloto_id") private Usuario piloto;` (opcional, nullable).  
  - `private byte[] imagen;` con `@Lob`, `@Column(nullable = true)`, `@JsonIgnore`.

- En BD: si usas `ddl-auto=update`, Hibernate crea `piloto_id` y la columna de imagen. Si hay datos existentes, `piloto_id` nullable sin problema.

**Verificación:** Compilación OK; Usuario tiene imagenCma; Licencia tiene piloto e imagen.

---

## PASO 2 — Controller “Mi perfil” (piloto)

- Crear un controller, por ejemplo `MiPerfilPilotoController` o `PilotoMiPerfilController`, en paquete `com.gestion.qnt.controller` (o `controller.piloto` si se quiere agrupar).
- Base URL: `ApiConstants.URL_BASE + "/mi-perfil"` → `/api/qnt/v1/mi-perfil`.
- En todos los métodos: obtener el usuario actual desde `Authentication` (principal es `AuthUser`). Para **configuración del perfil** (PUT /mi-perfil, PUT /mi-perfil/cambio-password) usar `@PreAuthorize("isAuthenticated()")` o incluir también `hasRole('USER')` para que cualquier usuario autenticado pueda acceder. Para CMA y licencias mantener `@PreAuthorize("hasRole('PILOTO') or hasRole('ADMIN')")`. Resolver el `Usuario` de negocio por id (usuario actual) para leer/actualizar solo sus datos.
- Inyectar: `IUsuarioBusiness`, `ILicenciaBusiness` (o los repos/servicios que uses para Licencia), y **`PasswordEncoder`** para el cambio de contraseña.

**Endpoints a implementar:**

| Método | Ruta | Descripción |
|--------|------|-------------|
| GET | /mi-perfil | Datos del usuario actual: usuario (sin password), cmaVencimiento, tieneImagenCma, horasVuelo, cantidadVuelos (si aplica), lista resumida de sus licencias si es piloto (id, nombre, numLicencia, caducidad). Para no pilotos, omitir CMA/licencias o devolver vacío. |
| **PUT** | **/mi-perfil** | **Configuración del perfil:** body con datos editables (nombre, apellido, dni; no incluir password ni email si se considera identificador). Actualizar solo el usuario actual. 200 OK. Solo usuario autenticado.** |
| **PUT** | **/mi-perfil/cambio-password** | **Body: `{ "oldPassword": "...", "newPassword": "..." }`. Validar contraseña actual con PasswordEncoder; si es correcta, actualizar a la nueva (hasheada). Solo usuario actual. 200 OK o 400 si la contraseña actual no coincide.** |
| GET | /mi-perfil/cma | Solo CMA: vencimiento y booleano "tieneImagen". Solo PILOTO o ADMIN (o 404/403 si no es piloto). |
| PUT | /mi-perfil/cma | Body: `{ "vencimiento": "2026-05-01" }`. Actualiza `cmaVencimiento` del usuario actual. |
| PUT | /mi-perfil/cma/imagen | Multipart file. Guardar en `Usuario.imagenCma`. Solo usuario actual. |
| GET | /mi-perfil/cma/imagen | Devuelve la imagen del CMA del usuario actual (404 si no tiene). |
| GET | /mi-perfil/licencias | Lista de licencias donde `piloto = usuario actual`. |
| POST | /mi-perfil/licencias | Body: nombre, numLicencia, fechaCompra, caducidad, version (activo por defecto true). Crear `Licencia` con `piloto = usuario actual`. 201. |
| PUT | /mi-perfil/licencias/{id} | Actualizar licencia solo si `licencia.getPiloto().getId()` coincide con el usuario actual. 404 si no existe o no es suya. |
| DELETE | /mi-perfil/licencias/{id} | Eliminar solo si la licencia es del usuario actual. 204. |
| PUT | /mi-perfil/licencias/{id}/imagen | Multipart; guardar en `Licencia.imagen` de esa licencia (solo si es del usuario actual). |
| GET | /mi-perfil/licencias/{id}/imagen | Devuelve la imagen de esa licencia (solo si es del usuario actual). 404 si no tiene imagen. |

**Verificación:** Llamadas con token de un usuario con rol PILOTO (o ADMIN) devuelven/modifican solo sus datos; sin rol PILOTO/ADMIN o sin token → 403.

---

## PASO 3 — Capa de negocio necesaria

- **Usuario:** ya existe `update(Usuario)` y `changePassword(email, oldPassword, newPassword, encoder)`. Para **cambio de contraseña** desde mi-perfil: obtener el email del usuario actual y llamar a `usuarioBusiness.changePassword(email, oldPassword, newPassword, passwordEncoder)`. Para **actualizar datos del perfil**: cargar usuario por id actual, setear nombre/apellido/dni (según body), llamar a `update(usuario)`. Para actualizar solo CMA (vencimiento o imagen), el controller puede cargar el usuario, setear `cmaVencimiento` o `imagenCma`, y llamar a `usuarioBusiness.update(usuario)`.
- **Licencia:**
  - Listar por piloto: en `LicenciaRepository` agregar `List<Licencia> findByPilotoId(Long pilotoId);` (o `findByPiloto(Usuario u)`). Si no existe servicio que filtre por piloto, el controller puede usar este método del repo inyectado o un método en ILicenciaBusiness tipo `listByPiloto(Long usuarioId)`.
  - Crear/actualizar/eliminar: usar los existentes `add`, `update`, `delete` de Licencia asegurando siempre que `piloto` sea el usuario actual al crear y que al actualizar/eliminar la licencia pertenezca al usuario actual (validación en controller o en servicio).

**Verificación:** No se puede crear/editar/borrar licencias de otro usuario ni cambiar el CMA de otro.

---

## PASO 4 — Seguridad y roles

- Asegurar que el rol **ROLE_PILOTO** exista en la tabla `roles` (migración o documentar en COMO_PROBAR_API). Si solo existe ROLE_USER, se puede usar ROLE_USER para esta funcionalidad y cambiar en el prompt “PILOTO” por “USER”, pero lo ideal es tener ROLE_PILOTO para pilotos.
- **Configuración del perfil (PUT /mi-perfil y PUT /mi-perfil/cambio-password):** proteger con `isAuthenticated()` o con `hasRole('PILOTO') or hasRole('ADMIN') or hasRole('USER')` para que **cualquier usuario autenticado** pueda editar sus datos y cambiar su contraseña.
- **CMA y licencias:** mantener `hasRole('PILOTO') or hasRole('ADMIN')` para que solo pilotos (y admins) gestionen CMA y licencias.
- No exponer `/mi-perfil/**` en `permitAll`.

---

## PASO 5 — Documentación

- En `docs/COMO_PROBAR_API.md` (o equivalente) agregar sección **"Mi perfil"** con:
  - Descripción: cualquier usuario autenticado puede ver y actualizar su perfil (datos y cambio de contraseña); usuarios con rol PILOTO (o ADMIN) además pueden gestionar CMA y licencias ANAC.
  - **Configuración:** PUT /mi-perfil (body: nombre, apellido, dni), PUT /mi-perfil/cambio-password (body: oldPassword, newPassword).
  - Ejemplos: GET/PUT /mi-perfil, /mi-perfil/cma, /mi-perfil/cma/imagen, GET/POST/PUT/DELETE /mi-perfil/licencias y PUT/GET /mi-perfil/licencias/{id}/imagen.
  - Header: `Authorization: Bearer <token>`.

---

## PASO 6 — Commit y tag

```bash
VERSION="v0.12.0"
SLUG="piloto-mi-perfil-cma-licencia"

git add gestion/src/main/java/com/gestion/qnt/model/Usuario.java \
        gestion/src/main/java/com/gestion/qnt/model/Licencia.java \
        gestion/src/main/java/com/gestion/qnt/repository/LicenciaRepository.java \
        gestion/src/main/java/com/gestion/qnt/controller/MiPerfilPilotoController.java \
        gestion/src/main/java/com/gestion/qnt/controller/dto/... \
        docs/COMO_PROBAR_API.md

git commit --no-verify -m "feat(mi-perfil): configuración de perfil, CMA y licencias ANAC

- PUT /mi-perfil (datos editables) y PUT /mi-perfil/cambio-password
- Usuario.imagenCma; Licencia.piloto e Licencia.imagen
- GET/PUT mi-perfil, CMA (vencimiento + imagen), CRUD mis licencias + imagen por licencia
- Configuración para cualquier usuario autenticado; CMA/licencias para PILOTO o ADMIN
- Documentación en COMO_PROBAR_API"

git tag -a "${VERSION}" -m "Release v0.12.0: Acciones piloto CMA y licencia ANAC"
```

(Ajustar la lista de archivos según los DTOs y paquetes que se creen.)

---

## Verificación final

- [ ] Usuario tiene campo imagenCma; Licencia tiene piloto e imagen; BD actualizada.
- [ ] **GET /mi-perfil** devuelve datos del usuario actual; **PUT /mi-perfil** actualiza nombre/apellido/dni del usuario actual.
- [ ] **PUT /mi-perfil/cambio-password** con oldPassword y newPassword actualiza la contraseña del usuario actual; 400 si la contraseña actual no coincide.
- [ ] GET /mi-perfil con token PILOTO incluye CMA y licencias; PUT/GET /mi-perfil/cma e imagen funcionan.
- [ ] GET /mi-perfil/licencias lista solo licencias del usuario actual; POST crea licencia con piloto = actual; PUT/DELETE solo en propias licencias.
- [ ] PUT/GET /mi-perfil/licencias/{id}/imagen funcionan y solo para licencias del usuario actual.
- [ ] Configuración (PUT perfil, cambio-password) accesible por cualquier usuario autenticado; CMA/licencias solo PILOTO o ADMIN.
- [ ] Build sin errores.

---

## Notas

- **DTO de actualización de perfil:** se puede usar un record o clase `ActualizarMiPerfilRequest` con nombre, apellido, dni (todos opcionales; solo los no null se actualizan). No incluir email si es el identificador de login; si se permite cambiar email, validar unicidad.
- **Cambio de contraseña:** reutilizar `IUsuarioBusiness.changePassword(email, oldPassword, newPassword, encoder)` pasando el email del usuario autenticado.
- Si `ILicenciaBusiness` no tiene `listByPiloto`, implementarlo en la capa de negocio y exponerlo desde el controller para no acoplar el controller al repositorio.
- Opcional: DTOs para respuesta de “mi perfil” (evitar exponer campos internos de entidades) y para request de crear/actualizar licencia (nombre, numLicencia, fechaCompra, caducidad, version).
- Para “subir CMA” se asume una sola imagen por usuario; si más adelante se requieren varias imágenes, se puede añadir una entidad tipo CmaImagen (usuario_id, orden, contenido).
