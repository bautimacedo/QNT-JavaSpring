# v0.13.0 — Roles asignables (PILOTO en UI), password_mission y datos de piloto

**VERSIÓN:** v0.13.0  
**SLUG:** roles-piloto-password-mission  
**DEPENDENCIAS:** v0.11.0 (registro/aprobación), v0.12.0 (mi-perfil CMA y licencias)  
**ESTIMACIÓN:** 1h 30min  
**PRIORIDAD:** alta

---

## Objetivo

1. **Que en la UI de gestión de usuarios** el desplegable "Asignar rol" muestre **todos** los roles existentes en la BD (incluido **ROLE_PILOTO**), no solo ROLE_ADMIN. El backend ya expone `GET /api/qnt/v1/roles` que devuelve todos los roles; la instrucción es para **frontend** y para **documentar** el contrato.
2. **Añadir el campo `password_mission`** en la entidad Usuario: VARCHAR(30), opcional. Es un dato propio del piloto (clave/contraseña para misiones). El piloto debe poder **ver y editar** su `password_mission` desde **mi-perfil**.
3. Dejar claro que un **usuario piloto** tiene: licencia(s) ANAC, certificado CMA y `password_mission`, y que todo ello (salvo asignación de rol) lo gestiona el propio piloto en **mi-perfil**. El admin solo asigna el rol PILOTO al aprobar o con "Asignar rol"; el piloto completa licencias, CMA y password_mission en su perfil.

---

## PASO 1 — Backend: campo `password_mission` en Usuario

**1.1 Modelo**

- En `Usuario.java` agregar:
  - `private String passwordMission;`
  - Anotaciones: `@Column(name = "password_mission", length = 30, nullable = true)`. Opcional: `@JsonIgnore` solo si no debe verse en listados de usuarios por admin; si el admin puede verlo (solo lectura), no poner `@JsonIgnore`. Recomendación: **no** poner `@JsonIgnore` para que en GET /mi-perfil y en GET /usuarios (si se desea) el campo aparezca; si en algún DTO se oculta, hacerlo ahí.
- En BD: con `ddl-auto=update` se crea la columna `password_mission`. Si se usa migración manual, añadir columna `password_mission VARCHAR(30) NULL` en tabla `usuarios`.

**1.2 Mi-perfil**

- En el controller de **mi-perfil** (p. ej. `MiPerfilPilotoController`):
  - **GET /mi-perfil:** incluir en la respuesta el campo `passwordMission` del usuario actual (para que el piloto lo vea y pueda editarlo en la UI). Puede ser parte del DTO de respuesta o del propio objeto Usuario si se expone.
  - **PUT /mi-perfil:** en el body de "actualizar datos del perfil" aceptar **opcionalmente** el campo `passwordMission` (string, máx. 30 caracteres). Si viene en el body, actualizar `usuario.setPasswordMission(...)` y guardar. Validar longitud ≤ 30.

**1.3 Documentación API**

- En `docs/COMO_PROBAR_API.md` (sección Mi perfil): indicar que el body de PUT /mi-perfil puede incluir `passwordMission` (opcional, máx. 30 caracteres).
- En `Importante-main/INFORME_BACKEND_PARA_FRONTEND.md`:
  - En la descripción del recurso Usuario / mi-perfil, añadir el campo **password_mission** (string, opcional, máx. 30), indicando que es editable por el usuario en PUT /mi-perfil y que es relevante para pilotos.

**Verificación:** Usuario tiene columna `password_mission`; GET y PUT /mi-perfil incluyen el campo; compilación y tests OK.

---

## PASO 2 — Contrato para el frontend: roles y piloto

**2.1 Listado de roles para "Asignar rol"**

- El backend **no filtra** roles: `GET /api/qnt/v1/roles` (con token ADMIN) devuelve **todos** los roles existentes en la tabla `roles` (p. ej. ROLE_ADMIN, ROLE_PILOTO, y si existe ROLE_USER).
- **Instrucción para el programador frontend:** En la pantalla de Gestión de Usuarios, al abrir el diálogo/modal "Asignar rol", obtener la lista de roles con **GET /api/qnt/v1/roles** (header `Authorization: Bearer <token_admin>`) y usar **toda** la lista devuelta para poblar el desplegable. **No** hardcodear ni filtrar por `codigo === 'ROLE_ADMIN'`. Mostrar cada rol por su `nombre` o `codigo` (ej. "Piloto" / "ROLE_PILOTO") según diseño. Así, en cuanto exista ROLE_PILOTO en la BD, aparecerá en el desplegable.

**2.2 Documentación en INFORME_BACKEND_PARA_FRONTEND.md**

- En la sección de **Roles** (o donde se describa GET /roles), añadir explícitamente:
  - "GET /roles devuelve **todos** los roles de la base de datos. El frontend debe usar esta respuesta para el desplegable 'Asignar rol' y mostrar **todos** los roles (p. ej. ROLE_ADMIN, ROLE_PILOTO), sin filtrar por código."
- En la sección de **roles y permisos**, recordar:
  - **ROLE_PILOTO:** puede gestionar su perfil de piloto en **mi-perfil**: datos personales, cambio de contraseña, CMA (vencimiento e imagen), licencias ANAC (CRUD e imagen por licencia) y **password_mission** (campo específico de piloto, 30 caracteres).

**Verificación:** Documentación actualizada; un desarrollador frontend que siga el informe puede implementar el desplegable con todos los roles y la edición de password_mission en mi-perfil.

---

## PASO 3 — Resumen para el piloto (reglas de negocio)

- Un usuario con rol **PILOTO** debe poder:
  - Ver y editar en **mi-perfil:** nombre, apellido, DNI, contraseña (cambio de contraseña), **password_mission**, CMA (vencimiento e imagen) y sus licencias ANAC (CRUD + imagen por licencia).
- El **administrador** puede:
  - Asignar el rol **ROLE_PILOTO** (o ROLE_ADMIN) desde "Asignar rol" o al aprobar un usuario pendiente (PUT /usuarios/{id}/aprobar con `roleCodigo: "ROLE_PILOTO"`).
  - No es obligatorio que el backend exija licencia ANAC o CMA para asignar rol PILOTO: el piloto puede completar esos datos después en mi-perfil. Si en el futuro se desea validar "piloto completo", se puede añadir en una iteración posterior.

---

## PASO 4 — Verificación final y commit

- [ ] Usuario tiene campo `password_mission` (VARCHAR 30, nullable); BD actualizada.
- [ ] GET /mi-perfil incluye `passwordMission`; PUT /mi-perfil acepta y persiste `passwordMission` (opcional, máx. 30).
- [ ] GET /roles devuelve todos los roles de la BD (sin filtro); documentado para frontend.
- [ ] INFORME_BACKEND_PARA_FRONTEND.md actualizado: uso de GET /roles para desplegable "Asignar rol", campo password_mission y capacidades del piloto en mi-perfil.
- [ ] Build sin errores.

```bash
VERSION="v0.13.0"
SLUG="roles-piloto-password-mission"

git add gestion/src/main/java/com/gestion/qnt/model/Usuario.java \
        gestion/src/main/java/com/gestion/qnt/controller/... \
        docs/COMO_PROBAR_API.md \
        Importante-main/INFORME_BACKEND_PARA_FRONTEND.md

git commit --no-verify -m "feat(usuarios): password_mission para piloto y doc roles en UI

- Usuario.password_mission (varchar 30); GET/PUT mi-perfil incluyen el campo
- Documentar GET /roles para desplegable Asignar rol (mostrar todos, incl. ROLE_PILOTO)
- INFORME: piloto edita CMA, licencias ANAC y password_mission en mi-perfil"

git tag -a "${VERSION}" -m "Release v0.13.0: roles piloto en UI y password_mission"
```

---

## Notas para el programador

- **Frontend:** Si la UI ya llama a GET /roles y aun así solo muestra ADMIN, revisar que no exista un filtro en el cliente (p. ej. `roles.filter(r => r.codigo === 'ROLE_ADMIN')`) ni una lista hardcodeada. Usar la respuesta completa de GET /roles.
- **BD:** Si en algún entorno la tabla `roles` no tiene ROLE_PILOTO, insertar: `INSERT INTO roles (codigo, nombre) VALUES ('ROLE_PILOTO', 'Piloto');` (o usar el script/documentación que ya exista para roles iniciales).
- **Seguridad:** `password_mission` no es la contraseña de login; es un dato de negocio del piloto. No hashearlo como el password de autenticación.
