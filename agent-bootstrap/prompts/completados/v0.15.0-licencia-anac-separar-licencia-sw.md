# v0.15.0 — Separar Licencia (SW) de LicenciaANAC (piloto) + foto de perfil

**VERSIÓN:** v0.15.0  
**SLUG:** licencia-anac-separar-licencia-sw-foto-perfil  
**DEPENDENCIAS:** v0.12.0 (mi-perfil), contexto actual de Licencia  
**ESTIMACIÓN:** 3h  
**PRIORIDAD:** alta

---

## Objetivo

1. **Licencia** solo para **licencias de software** (FlightHub, FlytBase, Compra, Dock). Quitar de Licencia el campo `piloto` (y `imagen` si solo era para piloto).
2. Crear **LicenciaANAC** para la **certificación del piloto** (ANAC), con el modelo correcto de dominio:
   - **No** incluir `numeroLicencia` (el CUIT es de la persona y va en el usuario u otro lado).
   - **No** incluir `nombre` (el nombre es el del piloto, ya está en Usuario).
   - **Sí** incluir: **foto del CMA**, **foto del Certificado de Idoneidad**, **fecha de vencimiento del CMA**, **caducidad** (vencimiento de la licencia), **fecha de emisión**.
3. Migrar mi-perfil para que use LicenciaANAC con esos campos y endpoints de imágenes (CMA e Idoneidad por licencia).
4. **Foto de perfil:** cada **Usuario** debe poder cargar una **foto de perfil**; exponer en mi-perfil la subida y la descarga.

---

## PASO 1 — Entidad LicenciaANAC (modelo corregido)

**1.1 Campos de LicenciaANAC**

- `id` (Long, PK).
- `piloto` (Usuario, ManyToOne, FK `piloto_id`, NOT NULL). El piloto ya tiene nombre en Usuario; no duplicar.
- **`fechaVencimientoCma`** (LocalDate, columna `fecha_vencimiento_cma`, nullable) — vencimiento del CMA.
- **`fechaEmision`** (LocalDate, columna `fecha_emision`, nullable) — fecha de emisión de la licencia/certificado.
- **`caducidad`** (LocalDate, nullable) — fecha de vencimiento de la licencia (certificado de idoneidad).
- **`imagenCma`** (byte[], @Lob, nullable, @JsonIgnore) — foto del Certificado Médico Aeronáutico.
- **`imagenCertificadoIdoneidad`** (byte[], @Lob, nullable, @JsonIgnore) — foto del Certificado de Idoneidad.
- `activo` (Boolean, default true).

**No incluir:** `numeroLicencia` (el CUIT es de la persona, no de la licencia ANAC en este contexto). **No incluir:** `nombre` (es el nombre del piloto, ya en Usuario).

**1.2 Repositorio**

- `LicenciaANACRepository` con `List<LicenciaANAC> findByPilotoId(Long pilotoId);`.

**Verificación:** Compila; tabla `licencias_anac` con columnas acordes (sin numero_licencia ni nombre si no se usan).

---

## PASO 2 — Capa de negocio LicenciaANAC

- **ILicenciaANACBusiness** / **LicenciaANACBusiness**: list(), load(Long id), listByPiloto(Long pilotoId), add(LicenciaANAC), update(LicenciaANAC), delete(Long id). Sin referencia a Compra ni Licencia.

---

## PASO 3 — Mi-perfil: LicenciaANAC y dos imágenes por licencia

- **MiPerfilPilotoController** usa **ILicenciaANACBusiness** para todo lo bajo `/mi-perfil/licencias`.
- **GET /mi-perfil:** resumen de licencias ANAC del usuario (id, fechaVencimientoCma, fechaEmision, caducidad, tieneImagenCma, tieneImagenCertificadoIdoneidad) — sin nombre ni numLicencia; el front puede mostrar “Licencia ANAC” + fechas.
- **GET /mi-perfil/licencias:** lista de LicenciaANAC del piloto (mismos campos útiles).
- **POST /mi-perfil/licencias:** body con `fechaVencimientoCma`, `fechaEmision`, `caducidad` (y `activo` opcional). Crear LicenciaANAC con piloto = usuario actual.
- **PUT /mi-perfil/licencias/{id}:** actualizar solo fechas (y activo); validar que la licencia sea del usuario actual.
- **DELETE /mi-perfil/licencias/{id}:** solo si la licencia es del usuario actual.

**Imágenes por licencia ANAC (dos fotos):**

- **PUT /mi-perfil/licencias/{id}/imagen-cma** — multipart `file` → guardar en `LicenciaANAC.imagenCma`.
- **GET /mi-perfil/licencias/{id}/imagen-cma** — devolver la imagen del CMA de esa licencia (404 si no tiene).
- **PUT /mi-perfil/licencias/{id}/imagen-certificado-idoneidad** — multipart `file` → guardar en `LicenciaANAC.imagenCertificadoIdoneidad`.
- **GET /mi-perfil/licencias/{id}/imagen-certificado-idoneidad** — devolver la imagen del Certificado de Idoneidad (404 si no tiene).

Si el front actual usa una sola “imagen” por licencia, se puede mantener **GET/PUT /mi-perfil/licencias/{id}/imagen** como alias de “certificado de idoneidad” para no romper el contrato, y añadir los endpoints específicos para CMA e Idoneidad. Documentar en el informe para el front.

**DTOs:** Ajustar **CrearLicenciaMiPerfilRequest** y **ActualizarLicenciaMiPerfilRequest** a: `fechaVencimientoCma`, `fechaEmision`, `caducidad`, `activo` (opcional). Sin `nombre` ni `numLicencia`.

---

## PASO 4 — Foto de perfil del usuario

**4.1 Modelo Usuario**

- Añadir en **Usuario**: **`imagenPerfil`** (byte[], @Lob, nullable, @JsonIgnore). Columna `imagen_perfil`.

**4.2 Mi-perfil**

- **PUT /mi-perfil/foto-perfil** — multipart `file`. Guardar en `Usuario.imagenPerfil` del usuario autenticado. Accesible por **cualquier usuario autenticado** (`isAuthenticated()`).
- **GET /mi-perfil/foto-perfil** — devolver la foto de perfil del usuario actual (404 si no tiene). Accesible por cualquier usuario autenticado.

**4.3 GET /mi-perfil**

- Incluir en la respuesta un booleano **`tieneFotoPerfil`** (true si `usuario.getImagenPerfil() != null && usuario.getImagenPerfil().length > 0`) para que el front sepa si mostrar avatar por defecto o la foto.

**Verificación:** Cualquier usuario logueado puede subir y obtener su foto de perfil; no requiere rol PILOTO.

---

## PASO 5 — Licencia solo para software; quitar piloto

- En **Licencia**: eliminar **piloto** (y columna `piloto_id`). Eliminar **imagen** si solo se usaba para piloto; si las licencias SW pueden tener documento, dejarla opcional.
- **LicenciaRepository**: quitar `findByPilotoId`.
- **LicenciaBusiness** / **ILicenciaBusiness**: quitar `listByPiloto`. El **LicenciaRestController** global sigue siendo CRUD de licencias de software (con Compra).
- Migración de datos: si en `licencias` hay filas con `piloto_id`, copiar a `licencias_anac` los datos útiles (piloto_id, fecha_compra → fecha_emision, caducidad, imagen → imagen_certificado_idoneidad o similar, activo); luego quitar `piloto_id` (y si aplica `imagen`) de `licencias`.

---

## PASO 6 — Documentación

- **ESTRUCTURA_BD_ENTIDADES.md:** Licencia solo software; nueva § **LicenciaANAC** con campos: piloto, fechaVencimientoCma, fechaEmision, caducidad, imagenCma, imagenCertificadoIdoneidad, activo. Sin numeroLicencia ni nombre.
- **INFORME_BACKEND_PARA_FRONTEND.md:** Mi perfil — licencias ANAC con dos imágenes (CMA y Certificado de Idoneidad); DTOs con fechaVencimientoCma, fechaEmision, caducidad; endpoints PUT/GET imagen-cma e imagen-certificado-idoneidad; foto de perfil: PUT/GET /mi-perfil/foto-perfil y tieneFotoPerfil en GET /mi-perfil.
- **docs/COMO_PROBAR_API.md:** actualizar ejemplos de mi-perfil (licencias ANAC y foto de perfil).

---

## Verificación final

- [ ] LicenciaANAC tiene fechaVencimientoCma, fechaEmision, caducidad, imagenCma, imagenCertificadoIdoneidad; sin numeroLicencia ni nombre.
- [ ] GET/POST/PUT/DELETE /mi-perfil/licencias y PUT/GET para imagen-cma e imagen-certificado-idoneidad funcionan con LicenciaANAC.
- [ ] Usuario tiene imagenPerfil; PUT/GET /mi-perfil/foto-perfil funcionan para cualquier usuario autenticado; GET /mi-perfil incluye tieneFotoPerfil.
- [ ] Licencia sin piloto; CRUD global /licencias sigue siendo solo licencias de software.
- [ ] Build sin errores.
