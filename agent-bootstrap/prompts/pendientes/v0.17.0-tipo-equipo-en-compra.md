# v0.17.0 — TipoEquipo en Compra: especificar qué equipo se compró

**VERSIÓN:** v0.17.0  
**SLUG:** tipo-equipo-en-compra  
**DEPENDENCIAS:** v0.16.0 (compras/proveedores listos)  
**ESTIMACIÓN:** 1h 30min  
**PRIORIDAD:** alta

---

## Problema a resolver

Cuando `tipoCompra = EQUIPO`, el frontend no tiene manera de saber **qué tipo de equipo** se compró (dron, dock, batería, hélice, antena RTK, antena Starlink, etc.). Esta info es necesaria para:
1. Mostrar correctamente en la pantalla de compras ("Equipo: Dron", "Equipo: Dock").
2. Cuando el equipo de inventario implemente el `// TODO Logica de Stock e Inventario`, saber en qué entidad crear el ítem.

---

## Propuesta (opinión y recomendación)

### ¿Por qué NO hacer FK directa a Dron, Dock, etc.?

Una compra de equipo **NO** es igual a un dron o dock ya existente en el sistema. La compra registra que **se pagó por un equipo**; el ítem en inventario (Dron, Dock, etc.) se crea **después**, cuando se lo da de alta. Poner FKs opcionales a todas las entidades en Compra sería:
- 7 columnas nullable en la tabla (`dron_id`, `dock_id`, `bateria_id`, `helice_id`, `antena_rtk_id`, `antena_starlink_id`...).
- Complejo de mantener; rompería si se agregan más tipos de equipo.

### ✅ Propuesta: nuevo enum `TipoEquipo` + campo nullable en Compra

Agregar:
1. **Enum `TipoEquipo`** con los tipos de equipo que maneja el sistema.
2. **Campo `tipoEquipo`** (nullable) en `Compra`: solo se setea cuando `tipoCompra = EQUIPO`.
3. **Campo `descripcionEquipo`** (String, nullable, max 255): texto libre opcional para detalles adicionales (ej: "DJI Dock 2 - SN: XYZ123"). Solo aplica cuando `tipoCompra = EQUIPO`.

Esto es simple, limpio, extensible (agregar un valor al enum si aparece un nuevo tipo de equipo) y no rompe ninguna otra entidad.

---

## PASO 1 — Crear enum TipoEquipo

Crear `com.gestion.qnt.model.enums.TipoEquipo`:

```java
public enum TipoEquipo {
    DRON,
    DOCK,
    BATERIA,
    HELICE,
    ANTENA_RTK,
    ANTENA_STARLINK,
    OTRO
}
```

---

## PASO 2 — Añadir campos a Compra

En `Compra.java`:
- `@Enumerated(EnumType.STRING) @Column(name = "tipo_equipo", nullable = true) private TipoEquipo tipoEquipo;`
- `@Column(name = "descripcion_equipo", length = 255, nullable = true) private String descripcionEquipo;`

Con `ddl-auto=update` Hibernate crea las columnas automáticamente. Si se usa migración manual: `ALTER TABLE compras ADD COLUMN tipo_equipo VARCHAR(30), ADD COLUMN descripcion_equipo VARCHAR(255);`

---

## PASO 3 — Actualizar DTO CreateCompraRequest

En `CreateCompraRequest` añadir:
- `TipoEquipo tipoEquipo` (nullable; solo obligatorio cuando tipoCompra = EQUIPO).
- `String descripcionEquipo` (nullable).

Agregar validación de negocio en `CompraBusiness.add` y `update`: si `tipoCompra == TipoCompra.EQUIPO && tipoEquipo == null`, lanzar `BusinessException("Se debe indicar el tipoEquipo cuando el tipo de compra es EQUIPO")`.

---

## PASO 4 — Actualizar CompraBusiness

En `CompraBusiness.add` y `CompraBusiness.update(Long id, CreateCompraRequest request)`:
- Setear `compra.setTipoEquipo(request.tipoEquipo())` y `compra.setDescripcionEquipo(request.descripcionEquipo())`.
- El bloque `// TODO Logica de Stock e Inventario` ya tiene `tipoEquipo` disponible en la compra para cuando el equipo de inventario lo necesite:

```java
if (compra.getTipoCompra() == TipoCompra.EQUIPO) {
    // TODO Logica de Stock e Inventario
    // compra.getTipoEquipo() indica qué entidad crear (DRON, DOCK, BATERIA, etc.)
    // compra.getDescripcionEquipo() puede usarse como nombre/modelo inicial del ítem
}
```

---

## PASO 5 — Endpoint GET /compras/tipos-equipo

En `CompraRestController`, añadir (igual que `/tipos` para TipoCompra):

```java
@GetMapping("/tipos-equipo")
@PreAuthorize("hasRole('ADMIN') or hasRole('USER')")
public ResponseEntity<TipoEquipo[]> getTiposEquipo() {
    return ResponseEntity.ok(TipoEquipo.values());
}
```

El front usa este endpoint para poblar el segundo dropdown ("Tipo de equipo") que aparece dinámicamente cuando el usuario selecciona `tipoCompra = EQUIPO`.

---

## PASO 6 — Filtro por tipoEquipo (opcional, bajo prioridad)

Si el front necesita filtrar compras por tipo de equipo, añadir `@RequestParam(required = false) TipoEquipo tipoEquipo` al GET /compras y actualizar el query JPQL en el repository. **Solo si el front lo pide**; no implementarlo preventivamente.

---

## PASO 7 — Documentar

**INFORME_BACKEND_PARA_FRONTEND.md:**

- En la sección de Compras, indicar que cuando `tipoCompra = "EQUIPO"`:
  - `tipoEquipo` es **obligatorio** (valores del enum: DRON, DOCK, BATERIA, HELICE, ANTENA_RTK, ANTENA_STARLINK, OTRO).
  - `descripcionEquipo` es opcional (texto libre, máx. 255 caracteres).
- Documentar el endpoint `GET /compras/tipos-equipo` que devuelve el array de valores válidos para el dropdown.

**Flujo de pantalla para el frontend:**
1. El usuario selecciona tipoCompra en el formulario.
2. Si `tipoCompra == "EQUIPO"` → mostrar un segundo select con los valores de `GET /compras/tipos-equipo` + campo de texto para `descripcionEquipo`.
3. Si `tipoCompra != "EQUIPO"` → ocultar esos campos.

---

## Verificación final

- [ ] Enum `TipoEquipo` existe con: DRON, DOCK, BATERIA, HELICE, ANTENA_RTK, ANTENA_STARLINK, OTRO.
- [ ] `Compra` tiene campos `tipoEquipo` y `descripcionEquipo` (nullable).
- [ ] `CreateCompraRequest` tiene `tipoEquipo` y `descripcionEquipo`; validación de negocio exige `tipoEquipo` cuando `tipoCompra = EQUIPO`.
- [ ] `CompraBusiness.add/update` setean `tipoEquipo` y `descripcionEquipo`; el TODO de Stock e Inventario incluye comentario sobre `tipoEquipo`.
- [ ] `GET /compras/tipos-equipo` devuelve el array del enum.
- [ ] INFORME_BACKEND_PARA_FRONTEND actualizado con el flujo de campos dinámicos.
- [ ] Build sin errores.
