# v0.1.0 ‚Äî Entidades JPA y Repositorios Spring Data

**VERSI√ìN:** v0.1.0  
**SLUG:** entity-repositories  
**DEPENDENCIAS:** ninguna  
**ESTIMACI√ìN:** 2h  
**PRIORIDAD:** alta

---

## Origen

> üóÇÔ∏è *Prompt generado por el Agente PM en la fase de desarrollo del Sistema de Gesti√≥n Operativa.*  
> *Objetivo: crear el modelo de persistencia (clases @Entity) y los repositorios Spring Data JPA en el backend Spring Boot, seg√∫n la estructura definida en docs/ESTRUCTURA_BD_ENTIDADES.md.*

---

## Descripci√≥n

Implementar en el m√≥dulo `gestion` del proyecto QNT Gestion:

1. **Enum de estado** y **todas las entidades JPA** descritas en `docs/ESTRUCTURA_BD_ENTIDADES.md`, con atributos y relaciones (One-to-Many, Many-to-One, One-to-One, Many-to-Many donde corresponda).
2. **Repositorios Spring Data JPA** (`JpaRepository<Entidad, Long>`) para cada entidad que requiera acceso a base de datos.

El documento de estructura define tipos Java, nombres de atributos, FKs y cardinalidades. Las entidades deben vivir en un paquete consistente (por ejemplo `com.gestion.qnt.domain` o `com.gestion.qnt.model.entity`) y los repositorios en `com.gestion.qnt.repository`. No se pide en esta tarea: controladores REST, servicios de negocio, ni migraciones Flyway/Liquibase (solo el modelo y los repositorios).

---

## PASO 0 ‚Äî Contexto previo a leer

> ‚ö†Ô∏è Si ven√≠s del AGENTE_WORKFLOW.md, saltear este paso.

Leer sin ejecutar nada:

- `docs/ESTRUCTURA_BD_ENTIDADES.md` ‚Äî especificaci√≥n completa de entidades, atributos y relaciones.
- `docs/ENTIDADES.md` ‚Äî contexto de negocio de cada entidad.
- `BLUEPRINT.md` ‚Äî estructura del proyecto (paquetes `domain/`, `repository/`).
- `gestion/pom.xml` ‚Äî verificar que existan `spring-boot-starter-data-jpa` y `postgresql`.

---

## PASO 1 ‚Äî Crear paquetes y enum Estado

En `gestion/src/main/java/com/gestion/qnt/`:

- Crear paquete `domain` (o `model.entity` seg√∫n BLUEPRINT).
- Crear enum `Estado` en `domain/Estado.java` con valores: `STOCK_ACTUAL`, `EN_PROCESO`, `STOCK_ACTIVO`, `EN_DESUSO`.
- Crear enum `TipoCompra` en `domain/TipoCompra.java` con valores: `LICENCIA_SW`, `REPUESTO`, `COMBUSTIBLE`, `VIATICO`, `SEGURO`, `EQUIPO`, `OTRO`.

**Verificaci√≥n:** el proyecto compila y los enums est√°n en el paquete correcto.

---

## PASO 2 ‚Äî Crear entidades en orden de dependencias

Crear las clases `@Entity` en este orden (para respetar referencias entre entidades):

1. **Site** ‚Äî id, nombre (sin Empresa; el sistema es para una sola empresa).
2. **Role** ‚Äî id, codigo (UNIQUE), nombre (tabla de roles para usuarios).
3. **Usuario** ‚Äî id, nombre, apellido, email, password, **roles (ManyToMany con Role)**, dni, cmaVencimiento, cmaImagenes, horasVuelo, cantidadVuelos.
4. **Proveedor** ‚Äî id, nombre, cuit, contacto, direccion, telefono, email, observaciones.
5. **Compra** ‚Äî id, proveedor (ManyToOne), fechaCompra, fechaFactura, numeroFactura, importe (BigDecimal), moneda, tipoCompra (enum TipoCompra), descripcion, site (ManyToOne opcional), observaciones.
6. **Seguro** ‚Äî id, aseguradora, numeroPoliza, vigenciaDesde, vigenciaHasta, observaciones, compra (ManyToOne opcional). Dock y Dron referencian Seguro por FK, no String.
7. **Licencia** ‚Äî id, nombre, numLicencia, **compra** (ManyToOne opcional ‚Üí Compra), fechaCompra, caducidad, version, activo.
8. **Dock** ‚Äî seg√∫n ESTRUCTURA_BD_ENTIDADES (incluye estado, site, dron, licencia, antenas, **seguro** FK a Seguro, **ultimoMantenimiento** FK a MantenimientoDock).
9. **AntenaRtk** ‚Äî id, dock (OneToOne), resto de atributos, estado.
10. **AntenaStarlink** ‚Äî id, dock, **fechaInstalacion**, resto de atributos, estado.
11. **Dron** ‚Äî id, dock (ManyToOne), **ultimoMantenimiento** (FK a MantenimientoDron), **seguro** (FK a Seguro), estado, atributos de negocio, relaciones OneToMany a bater√≠as/h√©lices/misiones (mappedBy).
12. **Bateria** ‚Äî id, dron (ManyToOne), estado, **fechaStockActivo**, **fechaEnDesuso**, resto de atributos.
13. **Helice** ‚Äî id, dron (ManyToOne), estado, **fechaStockActivo**, **fechaEnDesuso**, resto de atributos.
14. **MantenimientoDock** ‚Äî id, dock, usuario, fechaMantenimiento, observaciones, fotos.
15. **MantenimientoDron** ‚Äî id, dron, usuario, fechaMantenimiento, observaciones, fotos; **bateriaVieja**, **bateriaNueva** (ManyToOne Bateria); **helicesViejas**, **helicesNuevas** (ManyToMany con Helice; tablas join distintas).
16. **Instalacion** ‚Äî id, usuario, fecha, observaciones, fotos; dock, dron, bateria, helice (todas FK nullable).
17. **Pozo** ‚Äî id, nombre, coordenadas, site (ManyToOne).
18. **Mision** ‚Äî id, nombre, linkRtsp, descripcion, piloto (Usuario), dock, dron, pozo, fechaCreacion, **ultimaEjecucion** (no fechaEjecucion), estado.
19. **Log** ‚Äî id, entidadTipo, entidadId, timestamp, tipo, detalle, usuario (ManyToOne opcional).

Usar `@Table(name = "...")` en snake_case si se desea (ej. `mantenimiento_dock`). FKs con `@JoinColumn(name = "site_id")` etc.

**Verificaci√≥n:** todas las entidades compilan; no hay referencias circulares que impidan arrancar el contexto Spring (ajustar fetch = LAZY en relaciones OneToMany/ManyToOne si hace falta).

---

## PASO 3 ‚Äî Crear repositorios

En `gestion/src/main/java/com/gestion/qnt/repository/` crear interfaces que extiendan `JpaRepository<Entidad, Long>` para:

- SiteRepository  
- RoleRepository  
- UsuarioRepository  
- ProveedorRepository  
- CompraRepository  
- SeguroRepository  
- LicenciaRepository  
- DockRepository  
- AntenaRtkRepository  
- AntenaStarlinkRepository  
- DronRepository  
- BateriaRepository  
- HeliceRepository  
- MantenimientoDockRepository  
- MantenimientoDronRepository  
- InstalacionRepository  
- PozoRepository  
- MisionRepository  
- LogRepository  

No es necesario agregar m√©todos custom en esta tarea; solo la declaraci√≥n de la interfaz.

**Verificaci√≥n:** el proyecto compila; `mvn compile` o arrancar la aplicaci√≥n con un perfil que tenga BD configurada (o H2 en test) sin errores de Spring Data.

---

## PASO 4 ‚Äî Configuraci√≥n m√≠nima JPA (si no existe)

Si en `gestion/src/main/resources/` no existe configuraci√≥n JPA/DataSource:

- En `application.properties` o `application-dev.properties` definir al menos:  
  - `spring.datasource.url`, `username`, `password` (para desarrollo puede ser H2 o PostgreSQL local).  
  - `spring.jpa.hibernate.ddl-auto=validate` o `update` para desarrollo (seg√∫n criterio del equipo).  
  - `spring.jpa.show-sql=true` opcional para depuraci√≥n.

No generar scripts SQL en este ticket; solo asegurar que la aplicaci√≥n arranque con las entidades y repositorios (por ejemplo con H2 en test o PostgreSQL si est√° disponible).

**Verificaci√≥n:** `mvn spring-boot:run` o `mvn test` (incluyendo tests de contexto si existen) terminan sin fallos de carga de entidades/repositorios.

---

## PASO N ‚Äî Commit y tag

```bash
VERSION="v0.1.0"
SLUG="entity-repositories"

git add gestion/src/main/java/com/gestion/qnt/domain/ \
       gestion/src/main/java/com/gestion/qnt/repository/ \
       gestion/src/main/resources/application*.properties

git commit --no-verify -m "feat(domain): entidades JPA y repositorios Spring Data

- Enum Estado, TipoCompra; entidades Site, Role, Usuario, Proveedor, Compra, Seguro, Licencia, Dock, Dron
- AntenaRtk, AntenaStarlink, Bateria, Helice
- MantenimientoDock, MantenimientoDron, Instalacion, Pozo, Mision, Log
- Seguro como tabla (Dock/Dron con FK); Compras vinculadas a Proveedor; Licencia vinculada a Compra
- Repositorios JpaRepository para todas las entidades
- Especificaci√≥n de referencia: docs/ESTRUCTURA_BD_ENTIDADES.md"

git tag -a "${VERSION}" -m "Release v0.1.0: Entidades JPA y Repositorios"
```

---

## Verificaci√≥n final

- [ ] Build sin errores (`mvn clean compile`).
- [ ] Todas las entidades en el paquete acordado con atributos y relaciones seg√∫n ESTRUCTURA_BD_ENTIDADES.md.
- [ ] Repositorios creados para cada entidad listada.
- [ ] Contexto Spring Boot arranca sin errores de JPA/repositorios (con H2 en test o PostgreSQL configurado).
- [ ] Sin warnings relevantes de compilaci√≥n o JPA.

---

## Notas

- Compras (Proveedor, Compra, TipoCompra) y Seguro est√°n incluidos en este ticket seg√∫n ESTRUCTURA_BD_ENTIDADES.md.
- Para `Compra.importe` usar `java.math.BigDecimal`.
- Si el equipo prefiere paquete `model.entity` en lugar de `domain`, usar ese nombre de paquete de forma consistente.
- Para `Usuario.password` usar representaci√≥n adecuada (no guardar texto plano); codificaci√≥n/hash puede quedar para un ticket de seguridad posterior.
- Relaciones bidireccionales: mantener `mappedBy` en el lado no due√±o para evitar tablas duplicadas.
