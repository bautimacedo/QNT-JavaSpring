# v0.8.0 — REST Controller de Seguros (CRUD)

**VERSIÓN:** v0.8.0  
**SLUG:** controller-seguros  
**DEPENDENCIAS:** v0.4.0 (JWT)  
**ESTIMACIÓN:** 45min  
**PRIORIDAD:** alta

---

## Descripción

Implementar **SeguroRestController** con endpoints para **crear**, **editar**, **eliminar** y **listar** seguros, siguiendo el patrón de `CompraRestController` y `UsuarioRestController`. Autenticación con JWT en header `Authorization: Bearer <token>`; datos en body JSON. La capa de negocio (`ISeguroBusiness`) y la entidad `Seguro` ya existen.

---

## PASO 0 — Contexto previo a leer

- `gestion/src/main/java/com/gestion/qnt/model/Seguro.java` — aseguradora, numeroPoliza, vigenciaDesde, vigenciaHasta, observaciones, compra (ManyToOne opcional).
- `gestion/src/main/java/com/gestion/qnt/model/business/interfaces/ISeguroBusiness.java` — list(), load(id), add(), update(), delete().
- `gestion/src/main/java/com/gestion/qnt/controller/CompraRestController.java` — patrón de controlador y manejo de excepciones.
- `gestion/src/main/java/com/gestion/qnt/config/ApiConstants.java` — URL_BASE.

---

## PASO 1 — DTO de request para Seguro

Crear en `gestion/src/main/java/com/gestion/qnt/controller/dto/`:

**CreateSeguroRequest** (record o clase) con campos:

- `aseguradora` (String, obligatorio)
- `numeroPoliza` (String, opcional)
- `vigenciaDesde` (LocalDate, opcional)
- `vigenciaHasta` (LocalDate, opcional)
- `observaciones` (String, opcional)
- `compraId` (Long, opcional) — para asociar el seguro a una compra existente

Usar `@JsonProperty` si hace falta para nombres en JSON. Validaciones: `@NotNull` en aseguradora si se usa Bean Validation.

---

## PASO 2 — SeguroRestController

- **Clase:** `SeguroRestController` en paquete `com.gestion.qnt.controller`.
- **Base URL:** `ApiConstants.URL_BASE + "/seguros"` → `/api/qnt/v1/seguros`.
- **Inyectar:** `ISeguroBusiness` y `ICompraBusiness` (para resolver `compraId` opcional al crear/actualizar).

Endpoints:

| Método | Ruta    | Descripción                    | Autorización        |
|--------|---------|--------------------------------|---------------------|
| GET    | /       | Listar todos los seguros       | Autenticado         |
| GET    | /{id}   | Obtener seguro por id          | Autenticado         |
| POST   | /       | Crear seguro (body: DTO)       | Autenticado         |
| PUT    | /{id}   | Actualizar seguro (body: DTO)  | Autenticado         |
| DELETE | /{id}   | Eliminar seguro por id         | Autenticado (ADMIN) |

- **Crear:** si viene `compraId`, cargar `Compra` con `compraBusiness.load(compraId)`; si no existe → 404. Armar entidad `Seguro`, setear compra si corresponde, llamar `seguroBusiness.add(seguro)`, devolver 201 CREATED.
- **Actualizar:** cargar seguro por id; si no existe → 404. Aplicar campos del DTO; si viene `compraId`, cargar compra y setear (o null si no viene). `seguroBusiness.update(seguro)`, devolver 200 OK.
- **Eliminar:** `seguroBusiness.delete(id)` → 204 No Content. 404 si no existe.
- **Listar / GET por id:** delegar en `seguroBusiness.list()` y `seguroBusiness.load(id)`. Si hay `LazyInitializationException` al serializar (relación Compra), usar `@Transactional(readOnly = true)` en el método del controller o en el servicio.

**Verificación:** compilación OK; rutas bajo `/api/qnt/v1/seguros` protegidas con JWT.

---

## PASO 3 — Seguridad y documentación

- Rutas `/api/qnt/v1/seguros/**` requieren autenticación (JWT). No usar `permitAll`.
- Actualizar `docs/COMO_PROBAR_API.md`: sección **Seguros** con ejemplos de GET/POST/PUT/DELETE (header `Authorization: Bearer <token>`, body JSON de ejemplo).

---

## PASO 4 — Commit y tag

```bash
VERSION="v0.8.0"
SLUG="controller-seguros"

git add gestion/src/main/java/com/gestion/qnt/controller/SeguroRestController.java \
        gestion/src/main/java/com/gestion/qnt/controller/dto/CreateSeguroRequest.java \
        docs/COMO_PROBAR_API.md

git commit --no-verify -m "feat(seguros): REST controller CRUD seguros

- SeguroRestController GET list, GET by id, POST, PUT, DELETE
- DTO CreateSeguroRequest (aseguradora, numeroPoliza, vigencia, compraId)
- Rutas protegidas JWT; documentación en COMO_PROBAR_API"

git tag -a "${VERSION}" -m "Release v0.8.0: Controller Seguros"
```

---

## Verificación final

- [ ] Build sin errores.
- [ ] POST /api/qnt/v1/seguros con JWT y body JSON crea un seguro (201).
- [ ] PUT /api/qnt/v1/seguros/{id} actualiza y devuelve 200.
- [ ] DELETE /api/qnt/v1/seguros/{id} devuelve 204.
- [ ] GET sin token → 401.
- [ ] Documentación actualizada con ejemplos.

---

## Notas

- La entidad `Seguro` tiene relación opcional con `Compra`; el DTO usa `compraId` para no exponer entidades anidadas en el JSON de entrada.
