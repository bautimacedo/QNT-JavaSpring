# v0.6.0 — REST Controller de Compras

**VERSIÓN:** v0.6.0  
**SLUG:** controller-compras  
**DEPENDENCIAS:** v0.4.0 (JWT), v0.5.0 (usuarios/roles)  
**ESTIMACIÓN:** 1h  
**PRIORIDAD:** alta

---

## Objetivo

Implementar un **CompraRestController** que exponga endpoints REST para **crear**, **editar** y **eliminar** compras, siguiendo el mismo patrón que `UsuarioRestController` y `RoleRestController`. Todas las peticiones (salvo login) llevan el **JWT en el header** `Authorization: Bearer <token>`; los datos van en el **body en JSON**.

---

## Autenticación en requests posteriores al login

- **Login** (`POST /api/qnt/v1/auth/login`): no se envía header `Authorization`. Las credenciales van en el **body** JSON: `{"username":"email@ejemplo.com","password":"clave"}`.
- **Resto de endpoints** (compras, usuarios, roles, etc.): en cada request se envía el **token JWT** en el header:
  - `Authorization: Bearer <token>`
  El token se obtiene del body de la respuesta del login (texto plano). No se vuelven a enviar username ni password en los headers; solo el Bearer token.
- La **información del recurso** (datos de la compra, usuario, etc.) va en el **body** en formato **JSON**.

---

## PASO 0 — Contexto previo a leer

- `gestion/src/main/java/com/gestion/qnt/model/Compra.java` — entidad Compra (proveedor, fechas, importe, moneda, tipoCompra, site, etc.).
- `gestion/src/main/java/com/gestion/qnt/model/enums/TipoCompra.java` — enum (LICENCIA_SW, REPUESTO, COMBUSTIBLE, VIATICO, SEGURO, EQUIPO, OTRO).
- `gestion/src/main/java/com/gestion/qnt/model/business/interfaces/ICompraBusiness.java` — list, load(id), add, update, delete.
- `gestion/src/main/java/com/gestion/qnt/controller/UsuarioRestController.java` — patrón de controlador (rutas, @PreAuthorize, manejo de excepciones).
- `gestion/src/main/java/com/gestion/qnt/config/ApiConstants.java` — URL_BASE.

---

## PASO 1 — DTOs de request para Compra

Crear en `gestion/src/main/java/com/gestion/qnt/controller/dto/`:

**CreateCompraRequest** (o similar) para alta y edición, con campos en JSON que reciban IDs en lugar de entidades anidadas:

- `proveedorId` (Long, obligatorio)
- `fechaCompra` (LocalDate, obligatorio) — formato ISO: `"2025-03-01"`
- `fechaFactura` (LocalDate, opcional)
- `numeroFactura` (String, opcional)
- `importe` (BigDecimal, obligatorio)
- `moneda` (String, opcional; default "ARS")
- `tipoCompra` (String, obligatorio) — uno de los valores del enum `TipoCompra`
- `descripcion` (String, opcional)
- `siteId` (Long, opcional)
- `observaciones` (String, opcional)

Usar record o clase con getters/setters y validaciones básicas si se desea (por ejemplo `@NotNull` en proveedorId, fechaCompra, importe, tipoCompra).

---

## PASO 2 — CompraRestController

- **Clase:** `CompraRestController` en paquete `com.gestion.qnt.controller`.
- **Base URL:** `ApiConstants.URL_BASE + "/compras"` → `/api/qnt/v1/compras`.
- **Inyectar:** `ICompraBusiness`, `IProveedorBusiness`, `ISiteBusiness` (para resolver `proveedorId` y `siteId` desde el body y asignar las entidades a la `Compra`).

Endpoints:

| Método | Ruta | Descripción | Autorización |
|--------|------|-------------|--------------|
| GET | / | Listar todas las compras | Autenticado (ej. hasRole('ADMIN') o hasRole('USER')) |
| GET | /{id} | Obtener una compra por id | Autenticado |
| POST | / | Crear compra (body: DTO con proveedorId, fechaCompra, importe, tipoCompra, etc.) | Autenticado |
| PUT | /{id} | Editar compra (body: mismo DTO; id en la URL) | Autenticado |
| DELETE | /{id} | Eliminar compra por id | Autenticado (recomendado ADMIN) |

- **Crear compra:** leer el DTO del body, cargar `Proveedor` por `proveedorId` (NotFoundException si no existe), opcionalmente `Site` por `siteId`, armar la entidad `Compra`, llamar a `compraBusiness.add(compra)`, devolver 201 CREATED con la compra creada.
- **Editar compra:** asegurar que el id del path coincida con el recurso; cargar proveedor/site si vienen en el body; llamar a `compraBusiness.update(compra)`; devolver 200 OK con la compra actualizada. Si no existe → 404.
- **Eliminar compra:** `compraBusiness.delete(id)` → 204 No Content o 200 OK. Si no existe → 404.
- **Listar / obtener por id:** delegar en `compraBusiness.list()` y `compraBusiness.load(id)`. Considerar que `Compra` tiene relaciones lazy (Proveedor, Site); si al serializar a JSON se produce LazyInitializationException, usar `@Transactional(readOnly = true)` en el método del controller o en el servicio, o DTOs que no expongan entidades lazy.

**Verificación:** compilación correcta y rutas bajo `/api/qnt/v1/compras` disponibles con seguridad aplicada (JWT requerido).

---

## PASO 3 — Seguridad y documentación

- Las rutas `/api/qnt/v1/compras/**` deben requerir autenticación (JWT). No añadir `permitAll` para compras.
- Actualizar `docs/COMO_PROBAR_API.md` (o equivalente) con un apartado **Compras**: ejemplos de POST/PUT/DELETE con header `Authorization: Bearer <token>` y body JSON de ejemplo.

---

## PASO 4 — Commit y tag

```bash
VERSION="v0.6.0"
SLUG="controller-compras"

git add gestion/src/main/java/com/gestion/qnt/controller/CompraRestController.java \
        gestion/src/main/java/com/gestion/qnt/controller/dto/CreateCompraRequest.java \
        docs/COMO_PROBAR_API.md

git commit --no-verify -m "feat(compras): REST controller crear, editar, eliminar compras

- CompraRestController con GET list, GET by id, POST, PUT, DELETE
- DTO CreateCompraRequest con proveedorId, siteId, fechas, importe, tipoCompra
- Rutas protegidas con JWT; documentación de uso en COMO_PROBAR_API"

git tag -a "${VERSION}" -m "Release v0.6.0: Controller Compras"
```

---

## Verificación final

- [ ] Build sin errores.
- [ ] POST /api/qnt/v1/compras con JWT y body JSON crea una compra (201).
- [ ] PUT /api/qnt/v1/compras/{id} actualiza y devuelve 200.
- [ ] DELETE /api/qnt/v1/compras/{id} elimina y devuelve 204/200.
- [ ] GET sin token devuelve 401.
- [ ] Documentación actualizada con ejemplo de request (header Authorization + body JSON).
