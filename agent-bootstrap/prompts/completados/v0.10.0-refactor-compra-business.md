# v0.10.0 — Refactor CompraBusiness para delegar armado de entidad
2
3**VERSIÓN:** v0.10.0  
4**SLUG:** refactor-compra-business  
5**DEPENDENCIAS:** v0.6.0 (controller-compras), v0.7.0 (compra-imagen-factura)  
6**ESTIMACIÓN:** 1h  
7**PRIORIDAD:** alta
8
9---
10
11## Descripción
12
13El objetivo de este requerimiento es mover la lógica de armado de la entidad `Compra` (y la búsqueda de sus entidades relacionadas como `Proveedor` y `Site`) desde el `CompraRestController` hacia la capa de negocio (`CompraBusiness`). Esto favorece un controlador más "limpio" y centraliza las reglas de creación y actualización en `CompraBusiness`.
14
15**Para esto:**
161. `ICompraBusiness` debe recibir el DTO `CreateCompraRequest` en los métodos `add` y `update` en vez de la entidad `Compra`.
172. La inyección de `IProveedorBusiness` y `ISiteBusiness` debe removerse del controlador e inyectarse en `CompraBusiness`.
18
19---
20
21## PASO 0 — Contexto previo a leer
22
23> ⚠️ Si venís del AGENTE_WORKFLOW.md, saltear este paso — ya lo hiciste.
24
25Leer sin ejecutar nada:
26- `gestion/src/main/java/com/gestion/qnt/controller/CompraRestController.java`
27- `gestion/src/main/java/com/gestion/qnt/model/business/interfaces/ICompraBusiness.java`
28- `gestion/src/main/java/com/gestion/qnt/model/business/CompraBusiness.java`
29- `gestion/src/main/java/com/gestion/qnt/controller/dto/CreateCompraRequest.java`
30
31---
32
33## PASO 1 — Modificar ICompraBusiness
34
35En `gestion/src/main/java/com/gestion/qnt/model/business/interfaces/ICompraBusiness.java`, modificar la firma de los métodos `add` y `update`.
36
37```java
38    // Cambiar de Compra a CreateCompraRequest
39    Compra add(CreateCompraRequest request) throws NotFoundException, BusinessException;
40
41    // Cambiar de Compra a CreateCompraRequest. Se agrega el id a actualizar por separado o se puede mantener la carga del id
42    Compra update(Long id, CreateCompraRequest request) throws NotFoundException, BusinessException;
43```
44
45**Verificación:** Compilación fallará en las implementaciones y en el controller. Esto es esperado.
46
47---
48
49## PASO 2 — Implementar la lógica en CompraBusiness
50
51En `gestion/src/main/java/com/gestion/qnt/model/business/CompraBusiness.java`:
52
531. Inyectar `IProveedorBusiness proveedorBusiness` y `ISiteBusiness siteBusiness`.
542. Implementar los métodos `add` y `update` con las nuevas firmas.
553. Trasladar la lógica que estaba en el Controller para cargar `Proveedor` y `Site`, setear los campos del DTO en la entidad `Compra`.
564. Validar que la excepción `NotFoundException` lanzada desde `proveedorBusiness` o `siteBusiness` se propague (ahora está definida en la firma).
57
58**Verificación:** La clase `CompraBusiness` compila correctamente.
59
60---
61
62## PASO 3 — Limpiar CompraRestController
63
64En `gestion/src/main/java/com/gestion/qnt/controller/CompraRestController.java`:
65
661. Eliminar la inyección de `IProveedorBusiness` y `ISiteBusiness`.
672. Actualizar el método `create` para que solo llame a `compraBusiness.add(request)`.
683. Actualizar el método `update` para que solo llame a `compraBusiness.update(id, request)`.
69
70**Verificación:** El controlador ya no contiene lógica de mapeo ni dependencias extras a otros Business que no sean `ICompraBusiness`. Todo el proyecto compila.
71
72---
73
74## PASO 4 — Commit y tag
75
76```bash
77VERSION="v0.10.0"
78SLUG="refactor-compra-business"
79
80git add gestion/src/main/java/com/gestion/qnt/controller/CompraRestController.java \
81        gestion/src/main/java/com/gestion/qnt/model/business/CompraBusiness.java \
82        gestion/src/main/java/com/gestion/qnt/model/business/interfaces/ICompraBusiness.java
83
84git commit --no-verify -m "refactor(compras): mover logica de DTO a entidad al CompraBusiness
85
86- ICompraBusiness usa CreateCompraRequest en add y update
87- CompraBusiness asume la busqueda de Proveedor y Site
88- CompraRestController queda limpio y solo delega"
89
90git tag -a "${VERSION}" -m "Release ${VERSION}: Refactor CompraBusiness DTO mapping"
91```
92
93---
94
95## Verificación final
96
97Lista de criterios que deben cumplirse antes de considerar este prompt completo:
98
99- [ ] Proyecto compila sin errores
100- [ ] El endpoint `POST /api/qnt/v1/compras/` responde correctamente (HTTP 201) al crear una compra
101- [ ] El controlador `CompraRestController` no inyecta nada aparte de `ICompraBusiness`
102
103---
104
105## Notas / Consideraciones
106
107- Mantener las validaciones de `@Valid` en el Controller.
108- Si `siteId` es nulo, soportarlo como lo hacía el controller.
109- Utilizar el archivo `gestion/src/main/java/com/gestion/qnt/controller/dto/CreateCompraRequest.java` para el tipado.
