# v0.3.0 ‚Äî Interfaces y clases de l√≥gica de negocio (Business)

**VERSI√ìN:** v0.3.0  
**SLUG:** business-interfaces-and-classes  
**DEPENDENCIAS:** v0.2.0 (modelo con entidades en carpeta model)  
**ESTIMACI√ìN:** 2h  
**PRIORIDAD:** alta

---

## Origen

> üóÇÔ∏è *Prompt generado por el Agente PM.*  
> *El cliente pidi√≥: interfaces y m√©todos b√°sicos de l√≥gica de negocio para cada entidad, siguiendo el patr√≥n de otro proyecto (interface I*Business + clase *Business con list, load, add, update, delete; uso de BusinessException, NotFoundException, FoundException).*

---

## Descripci√≥n

Implementar la **capa de l√≥gica de negocio** del m√≥dulo `gestion`:

1. **Interfaces** `I*Business` en `com.gestion.qnt.model.business.interfaces` con los m√©todos b√°sicos: `list()`, `load(Long id)`, `add(entity)`, `update(entity)`, `delete(Long id)`. Donde tenga sentido (entidad con campo √∫nico), agregar `load(campoUnico)` y validar duplicados en add/update.
2. **Clases** `*Business` en `com.gestion.qnt.model.business` que implementen cada interfaz, con `@Service`, inyecci√≥n del repositorio correspondiente, y los m√©todos delegando al repositorio y lanzando las excepciones del paquete `com.gestion.qnt.model.business.exceptions` (BusinessException, NotFoundException, FoundException).
3. **Repositorios** Spring Data JPA: si no existen, crear en `com.gestion.qnt.repository` interfaces `*Repository` que extiendan `JpaRepository<Entidad, Long>`, con los m√©todos de b√∫squeda necesarios para las validaciones de negocio (ej. `findByEmail` para Usuario, `findByCodigo` para Role).

**Patr√≥n de referencia:** el ejemplo que sigue (proyecto con Cisterna). Adaptar paquetes a `com.gestion.qnt` y nombres de entidad/repositorio a las del proyecto QNT Gestion.

**Ejemplo de interfaz (ICisternaBusiness):**
- `List<Cisterna> list() throws BusinessException`
- `Cisterna load(long id) throws NotFoundException, BusinessException`
- `Cisterna load(String licencia) throws NotFoundException, BusinessException`  *(por campo √∫nico)*
- `Cisterna add(Cisterna cisterna) throws FoundException, BusinessException`
- `Cisterna update(Cisterna cisterna) throws FoundException, NotFoundException, BusinessException`
- `void delete(long id) throws NotFoundException, BusinessException`

**Ejemplo de clase (CisternaBusiness):**
- `@Slf4j` `@Service`, implementa `ICisternaBusiness`.
- `@Autowired` al repositorio.
- `list()`: `repository.findAll()`; en catch lanzar `BusinessException`.
- `load(id)`: `repository.findById(id).orElseThrow(() -> new NotFoundException("..."))`; si es NotFoundException re-lanzar; resto ‚Üí BusinessException.
- `load(licencia)`: `repository.findByLicencia(licencia).orElseThrow(...)`; mismo manejo.
- `add(entity)`: si existe por campo √∫nico (ej. licencia) ‚Üí `throw new FoundException("...")`; sino `repository.save(entity)`; FoundException/resto re-lanzar o BusinessException.
- `update(entity)`: llamar `load(entity.getId())` para validar existencia; si otro tiene el mismo campo √∫nico ‚Üí FoundException; sino `repository.save(entity)`.
- `delete(id)`: `load(id)` y luego `repository.deleteById(id)`; en catch log + BusinessException.

Las excepciones **ya existen** en el proyecto en `com.gestion.qnt.model.business.exceptions`: `BusinessException`, `NotFoundException`, `FoundException`. Usarlas tal cual (con mensaje y/o causa).

**Alcance excluido:** controladores REST, DTOs, seguridad, tests (opcional no obligatorio en este ticket).

---

## PASO 0 ‚Äî Contexto previo a leer

> ‚ö†Ô∏è Si ven√≠s del AGENTE_WORKFLOW.md, saltear este paso.

Leer sin ejecutar nada:

- `gestion/src/main/java/com/gestion/qnt/model/business/exceptions/BusinessException.java`
- `gestion/src/main/java/com/gestion/qnt/model/business/exceptions/NotFoundException.java`
- `gestion/src/main/java/com/gestion/qnt/model/business/exceptions/FoundException.java`
- Listar entidades en `gestion/src/main/java/com/gestion/qnt/model/` (excluir enums y subcarpetas si solo contienen enums) para saber sobre cu√°les crear interface + business.

---

## PASO 1 ‚Äî Repositorios (si no existen)

En `gestion/src/main/java/com/gestion/qnt/repository/` crear una interfaz por cada entidad que vaya a tener l√≥gica de negocio, por ejemplo:

- `SiteRepository extends JpaRepository<Site, Long>`
- `RoleRepository extends JpaRepository<Role, Long>` + `Optional<Role> findByCodigo(String codigo);` (y si hace falta para update: `findByCodigoAndIdNot(String codigo, Long id)`)
- `UsuarioRepository extends JpaRepository<Usuario, Long>` + `Optional<Usuario> findByEmail(String email);` + `Optional<Usuario> findByEmailAndIdNot(String email, Long id);`
- `ProveedorRepository`, `CompraRepository`, `SeguroRepository`, `LicenciaRepository`
- `DockRepository`, `AntenaRtkRepository`, `AntenaStarlinkRepository`, `MantenimientoDockRepository`, `MantenimientoDronRepository`
- `DronRepository`, `BateriaRepository`, `HeliceRepository`, `InstalacionRepository`, `PozoRepository`, `MisionRepository`, `LogRepository`

Solo declarar los m√©todos que vayan a usar las clases Business (findById ya viene de JpaRepository; agregar findByX para unicidad cuando corresponda).

**Verificaci√≥n:** el proyecto compila con `mvn -f gestion/pom.xml compile`.

---

## PASO 2 ‚Äî Interfaces I*Business

En `gestion/src/main/java/com/gestion/qnt/model/business/interfaces/` crear una interfaz por entidad. Nombre: `I<Entidad>Business` (ej. `ISiteBusiness`, `IUsuarioBusiness`).

M√©todos est√°ndar en cada una:

- `List<Entidad> list() throws BusinessException;`
- `Entidad load(Long id) throws NotFoundException, BusinessException;`
- `Entidad add(Entidad entity) throws FoundException, BusinessException;`
- `Entidad update(Entidad entity) throws FoundException, NotFoundException, BusinessException;`
- `void delete(Long id) throws NotFoundException, BusinessException;`

**Donde aplique**, agregar un `load` por campo √∫nico y validar ese campo en add/update:

- **Usuario:** `Usuario load(String email) throws NotFoundException, BusinessException;` ‚Äî en add/update validar que no exista otro usuario con el mismo email (FoundException).
- **Role:** `Role load(String codigo) throws NotFoundException, BusinessException;` ‚Äî en add/update validar que no exista otro rol con el mismo codigo (FoundException).

Para el resto de entidades (Site, Proveedor, Compra, Seguro, Licencia, Dock, AntenaRtk, AntenaStarlink, MantenimientoDock, MantenimientoDron, Dron, Bateria, Helice, Instalacion, Pozo, Mision, Log) dejar solo los cinco m√©todos est√°ndar (list, load(id), add, update, delete). Si alguna entidad tiene en el modelo un campo √∫nico documentado (ej. numeroSerie √∫nico), se puede a√±adir load(eseCampo) y validaci√≥n en add/update en el siguiente paso.

**Verificaci√≥n:** las interfaces compilan y est√°n en el paquete correcto.

---

## PASO 3 ‚Äî Clases *Business

En `gestion/src/main/java/com/gestion/qnt/model/business/` crear una clase por entidad. Nombre: `<Entidad>Business` (ej. `SiteBusiness`, `UsuarioBusiness`). Cada clase debe:

- Anotarse con `@Service` y `@Slf4j`.
- Implementar la interfaz `I<Entidad>Business` correspondiente.
- Tener `@Autowired` (o constructor con el repositorio inyectado) del `*Repository` de esa entidad.
- Implementar cada m√©todo siguiendo el patr√≥n del ejemplo CisternaBusiness:
  - **list:** `repository.findAll()` en try; en catch lanzar `BusinessException(message, e)`.
  - **load(id):** `repository.findById(id).orElseThrow(() -> new NotFoundException("No existe ... con id " + id))`; catch NotFoundException re-lanzar; resto ‚Üí BusinessException.
  - **load(campoUnico):** igual con el finder correspondiente (ej. findByEmail) y mensaje apropiado.
  - **add:** si la entidad tiene campo √∫nico (email, codigo, etc.), comprobar con el repository si ya existe; si existe ‚Üí `throw new FoundException("Ya existe ...");`; sino `repository.save(entity)`; catch FoundException re-lanzar; resto ‚Üí BusinessException.
  - **update:** llamar `load(entity.getId())` para comprobar que existe; si hay campo √∫nico, comprobar que ning√∫n otro (id distinto) tenga el mismo valor ‚Üí FoundException si hay duplicado; sino `repository.save(entity)`; re-lanzar FoundException/NotFoundException; resto ‚Üí BusinessException.
  - **delete:** llamar `load(id)` (para validar existencia) y luego `repository.deleteById(id)`; en catch log.error y BusinessException.

Usar siempre el paquete de excepciones del proyecto: `com.gestion.qnt.model.business.exceptions`.

**Verificaci√≥n:** el proyecto compila; no es obligatorio arrancar la aplicaci√≥n ni ejecutar tests en este ticket, pero s√≠ que no haya errores de compilaci√≥n.

---

## PASO 4 ‚Äî Verificaci√≥n final

- [ ] Existe un repositorio por cada entidad que tenga Business (o se reutiliza uno existente).
- [ ] Existe una interfaz `I*Business` y una clase `*Business` por cada entidad listada.
- [ ] Todas las clases Business usan las excepciones del proyecto (BusinessException, NotFoundException, FoundException).
- [ ] Usuario y Role tienen adem√°s load(campoUnico) y validaci√≥n de duplicado en add/update.
- [ ] Build sin errores: `mvn -f gestion/pom.xml clean compile`.

---

## PASO N ‚Äî Commit y tag

```bash
VERSION="v0.3.0"
SLUG="business-interfaces-and-classes"

git add gestion/src/main/java/com/gestion/qnt/repository/ \
       gestion/src/main/java/com/gestion/qnt/model/business/

git commit --no-verify -m "feat(business): interfaces y clases de l√≥gica de negocio

- Repositorios JpaRepository por entidad (con finders para unicidad donde aplica)
- Interfaces I*Business con list, load(id), add, update, delete
- Clases *Business implementando cada interfaz; uso de BusinessException, NotFoundException, FoundException
- Usuario y Role con load por email/codigo y validaci√≥n de duplicados en add/update"

git tag -a "${VERSION}" -m "Release v0.3.0: Interfaces y Business"
```

---

## Notas

- El patr√≥n a seguir es el del ejemplo CisternaBusiness / ICisternaBusiness del otro proyecto; solo cambian paquetes (`com.gestion.qnt`) y nombres de entidad/repositorio.
- No implementar controladores REST ni DTOs en este ticket.
- Si un repositorio ya existe en el proyecto, no duplicar; usar el existente y a√±adir solo los m√©todos de b√∫squeda que falten para las validaciones de negocio.
